<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIMER - An√°lisis de Temperaturas V Regi√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Comunas de la V regi√≥n con sus coordenadas y venta neta mensual (noviembre 2024)
        const COMUNAS = [
            // Provincia de Valpara√≠so
            { nombre: "Valpara√≠so", lat: -33.0472, lon: -71.6127, ventaNeta: 184704766 },
            { nombre: "Vi√±a del Mar", lat: -33.0246, lon: -71.5518, ventaNeta: 325221662 },
            { nombre: "Quilpu√©", lat: -33.0472, lon: -71.4425, ventaNeta: 115108130 },
            { nombre: "Villa Alemana", lat: -33.0453, lon: -71.3729, ventaNeta: 88806010 },
            { nombre: "Conc√≥n", lat: -32.9254, lon: -71.5203, ventaNeta: 43316836 },
            { nombre: "Quintero", lat: -32.7833, lon: -71.5333, ventaNeta: 23306251 },
            { nombre: "Puchuncav√≠", lat: -32.7333, lon: -71.4167, ventaNeta: 28347751 },
            { nombre: "Casablanca", lat: -33.3167, lon: -71.4167, ventaNeta: 36179345 },
            
            // Provincia de San Antonio
            { nombre: "San Antonio", lat: -33.5953, lon: -71.6178, ventaNeta: 69552087 },
            { nombre: "Cartagena", lat: -33.5533, lon: -71.6089, ventaNeta: 24000831 },
            { nombre: "El Tabo", lat: -33.4500, lon: -71.6500, ventaNeta: 20870159 },
            { nombre: "El Quisco", lat: -33.3950, lon: -71.6978, ventaNeta: 34914158 },
            { nombre: "Algarrobo", lat: -33.3667, lon: -71.6667, ventaNeta: 40109118 },
            { nombre: "Santo Domingo", lat: -33.6500, lon: -71.6167, ventaNeta: 17115238 },
            
            // Provincia de Quillota
            { nombre: "Quillota", lat: -32.8833, lon: -71.2500, ventaNeta: 70713481 },
            { nombre: "La Calera", lat: -32.7833, lon: -71.2000, ventaNeta: 43349171 },
            { nombre: "La Cruz", lat: -32.8333, lon: -71.2333, ventaNeta: 20531433 },
            { nombre: "Nogales", lat: -32.7333, lon: -71.2167, ventaNeta: 19477480 },
            { nombre: "Hijuelas", lat: -32.8167, lon: -71.1667, ventaNeta: 28654980 },
            { nombre: "Limache", lat: -33.0167, lon: -71.2667, ventaNeta: 53296589 },
            { nombre: "Olmu√©", lat: -33.0100, lon: -71.2000, ventaNeta: 27337219 },
            
            // Provincia de Los Andes
            { nombre: "Los Andes", lat: -32.8333, lon: -70.6000, ventaNeta: 76323074 },
            { nombre: "San Esteban", lat: -32.7833, lon: -70.5833, ventaNeta: 17458034 },
            { nombre: "Calle Larga", lat: -32.8667, lon: -70.6333, ventaNeta: 12692845 },
            { nombre: "Rinconada", lat: -32.8333, lon: -70.7167, ventaNeta: 20046378 },
            
            // Provincia de San Felipe
            { nombre: "San Felipe", lat: -32.7500, lon: -70.7333, ventaNeta: 77452377 },
            { nombre: "Putaendo", lat: -32.6333, lon: -70.7167, ventaNeta: 19635479 },
            { nombre: "Santa Mar√≠a", lat: -32.7500, lon: -70.6667, ventaNeta: 11455420 },
            { nombre: "Panquehue", lat: -32.8167, lon: -70.8333, ventaNeta: 11926739 },
            { nombre: "Llaillay", lat: -32.8333, lon: -70.9667, ventaNeta: 37584413 },
            { nombre: "Catemu", lat: -32.7833, lon: -70.8833, ventaNeta: 18685339 },
            
            // Provincia de Petorca
            { nombre: "La Ligua", lat: -32.4500, lon: -71.2333, ventaNeta: 45495504 },
            { nombre: "Cabildo", lat: -32.4167, lon: -71.0833, ventaNeta: 23261597 },
            { nombre: "Papudo", lat: -32.5167, lon: -71.4500, ventaNeta: 11993620 },
            { nombre: "Zapallar", lat: -32.5500, lon: -71.4667, ventaNeta: 15106280 },
            { nombre: "Petorca", lat: -32.2500, lon: -70.9333, ventaNeta: 11874334 },
            { nombre: "Chincolco", lat: -32.6000, lon: -70.9667, ventaNeta: 0 },
            
            // Otras comunas
            { nombre: "Melipilla", lat: -33.6833, lon: -71.2167, ventaNeta: 114558107 },
            { nombre: "Curacav√≠", lat: -33.4000, lon: -71.1333, ventaNeta: 33436083 },
            { nombre: "Mar√≠a Pinto", lat: -33.5167, lon: -71.1333, ventaNeta: 13805094 },
            { nombre: "Illapel", lat: -31.6333, lon: -71.1667, ventaNeta: 36184151 },
            { nombre: "Salamanca", lat: -31.7667, lon: -70.9667, ventaNeta: 20545076 },
            { nombre: "Los Vilos", lat: -31.9167, lon: -71.5167, ventaNeta: 35626556 }
        ];

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (username === 'dimer' && password === 'Dimer2025') {
                    onLogin();
                } else {
                    setError('Usuario o contrase√±a incorrectos');
                    setPassword('');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">DIMER</h1>
                            <p className="text-gray-600">An√°lisis de Temperaturas V Regi√≥n</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Usuario
                                </label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                    placeholder="Ingrese su usuario"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Contrase√±a
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                    placeholder="Ingrese su contrase√±a"
                                    required
                                />
                            </div>
                            
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl"
                            >
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const TemperatureComparison = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [progress, setProgress] = useState(0);
            const [dateRange, setDateRange] = useState({ start: '', end: '', label: '' });
            const [selectedProvince, setSelectedProvince] = useState('Todas');
            const [usePonderado, setUsePonderado] = useState(true);

            const provincias = ['Todas', 'DIMER', 'Otras', 'Valpara√≠so', 'San Antonio', 'Quillota', 'Los Andes', 'San Felipe', 'Petorca'];
            
            // Comunas que atiende DIMER
            const COMUNAS_DIMER = ['Vi√±a del Mar', 'Valpara√≠so', 'Quilpu√©', 'Villa Alemana', 'Olmu√©', 'Limache'];
            
            const getComunaProvince = (comunaNombre) => {
                if (COMUNAS_DIMER.includes(comunaNombre)) return 'DIMER';
                
                const provinceMap = {
                    'Valpara√≠so': ['Conc√≥n', 'Quintero', 'Puchuncav√≠', 'Casablanca'],
                    'San Antonio': ['San Antonio', 'Cartagena', 'El Tabo', 'El Quisco', 'Algarrobo', 'Santo Domingo'],
                    'Quillota': ['Quillota', 'La Calera', 'La Cruz', 'Nogales', 'Hijuelas'],
                    'Los Andes': ['Los Andes', 'San Esteban', 'Calle Larga', 'Rinconada'],
                    'San Felipe': ['San Felipe', 'Putaendo', 'Santa Mar√≠a', 'Panquehue', 'Llaillay', 'Catemu'],
                    'Petorca': ['La Ligua', 'Cabildo', 'Papudo', 'Zapallar', 'Petorca', 'Chincolco']
                };
                
                for (const [province, comunas] of Object.entries(provinceMap)) {
                    if (comunas.includes(comunaNombre)) return province;
                }
                return 'Otras';
            };

            const filteredData = selectedProvince === 'Todas' 
                ? data 
                : selectedProvince === 'DIMER'
                ? data.filter(row => COMUNAS_DIMER.includes(row.comuna))
                : selectedProvince === 'Otras'
                ? data.filter(row => !COMUNAS_DIMER.includes(row.comuna))
                : data.filter(row => getComunaProvince(row.comuna) === selectedProvince);

            // Formatear venta neta
            const formatVentaNeta = (num) => {
                return '$' + new Intl.NumberFormat('es-CL').format(num);
            };

            // Calcular promedios ponderados por venta neta para grupos de comunas
            const calculateGroupAverage = (comunas, ponderado = true) => {
                if (comunas.length === 0) return null;
                
                // Obtener datos de venta neta
                const comunasConVentas = comunas.map(c => {
                    const comunaData = COMUNAS.find(com => com.nombre === c.comuna);
                    const ventaNeta = comunaData?.ventaNeta || 0;
                    
                    return {
                        ...c,
                        ventaNeta: ventaNeta
                    };
                });

                const totalVentas = comunasConVentas.reduce((sum, c) => sum + c.ventaNeta, 0);
                
                let avgActual, avgAnterior;
                
                if (ponderado && totalVentas > 0) {
                    // Calcular promedios ponderados por venta neta
                    const weightedActual = {
                        max: comunasConVentas.reduce((sum, c) => sum + (c.actual.max * c.ventaNeta), 0) / totalVentas,
                        min: comunasConVentas.reduce((sum, c) => sum + (c.actual.min * c.ventaNeta), 0) / totalVentas,
                        mean: comunasConVentas.reduce((sum, c) => sum + (c.actual.mean * c.ventaNeta), 0) / totalVentas
                    };
                    
                    const weightedAnterior = {
                        max: comunasConVentas.reduce((sum, c) => sum + (c.anterior.max * c.ventaNeta), 0) / totalVentas,
                        min: comunasConVentas.reduce((sum, c) => sum + (c.anterior.min * c.ventaNeta), 0) / totalVentas,
                        mean: comunasConVentas.reduce((sum, c) => sum + (c.anterior.mean * c.ventaNeta), 0) / totalVentas
                    };
                    
                    avgActual = {
                        max: Math.round(weightedActual.max * 10) / 10,
                        min: Math.round(weightedActual.min * 10) / 10,
                        mean: Math.round(weightedActual.mean * 10) / 10
                    };
                    
                    avgAnterior = {
                        max: Math.round(weightedAnterior.max * 10) / 10,
                        min: Math.round(weightedAnterior.min * 10) / 10,
                        mean: Math.round(weightedAnterior.mean * 10) / 10
                    };
                } else {
                    // Calcular promedios simples
                    const sumActual = {
                        max: comunasConVentas.reduce((sum, c) => sum + c.actual.max, 0),
                        min: comunasConVentas.reduce((sum, c) => sum + c.actual.min, 0),
                        mean: comunasConVentas.reduce((sum, c) => sum + c.actual.mean, 0)
                    };
                    
                    const sumAnterior = {
                        max: comunasConVentas.reduce((sum, c) => sum + c.anterior.max, 0),
                        min: comunasConVentas.reduce((sum, c) => sum + c.anterior.min, 0),
                        mean: comunasConVentas.reduce((sum, c) => sum + c.anterior.mean, 0)
                    };
                    
                    const count = comunasConVentas.length;
                    
                    avgActual = {
                        max: Math.round((sumActual.max / count) * 10) / 10,
                        min: Math.round((sumActual.min / count) * 10) / 10,
                        mean: Math.round((sumActual.mean / count) * 10) / 10
                    };
                    
                    avgAnterior = {
                        max: Math.round((sumAnterior.max / count) * 10) / 10,
                        min: Math.round((sumAnterior.min / count) * 10) / 10,
                        mean: Math.round((sumAnterior.mean / count) * 10) / 10
                    };
                }
                
                const calcPercentage = (val2025, val2024) => {
                    if (val2024 === 0) return 0;
                    return Math.round(((val2025 - val2024) / val2024) * 100 * 10) / 10;
                };
                
                return {
                    actual: avgActual,
                    anterior: avgAnterior,
                    ventaNeta: totalVentas,
                    variacion: {
                        max: {
                            abs: Math.round((avgActual.max - avgAnterior.max) * 10) / 10,
                            pct: calcPercentage(avgActual.max, avgAnterior.max)
                        },
                        min: {
                            abs: Math.round((avgActual.min - avgAnterior.min) * 10) / 10,
                            pct: calcPercentage(avgActual.min, avgAnterior.min)
                        },
                        mean: {
                            abs: Math.round((avgActual.mean - avgAnterior.mean) * 10) / 10,
                            pct: calcPercentage(avgActual.mean, avgAnterior.mean)
                        }
                    }
                };
            };

            // Organizar datos: comunas DIMER primero, luego otras
            const organizedData = [...data].sort((a, b) => {
                const aIsDimer = COMUNAS_DIMER.includes(a.comuna);
                const bIsDimer = COMUNAS_DIMER.includes(b.comuna);
                
                if (aIsDimer && !bIsDimer) return -1;
                if (!aIsDimer && bIsDimer) return 1;
                
                // Dentro de DIMER, mantener el orden original
                if (aIsDimer && bIsDimer) {
                    return COMUNAS_DIMER.indexOf(a.comuna) - COMUNAS_DIMER.indexOf(b.comuna);
                }
                
                return a.comuna.localeCompare(b.comuna);
            });

            // Funci√≥n para obtener las fechas din√°micas
            const getDateRanges = () => {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth(); // 0-11
                const currentDay = today.getDate();
                
                // Fecha de inicio: d√≠a 1 del mes actual
                const startDate2025 = new Date(currentYear, currentMonth, 1);
                // Fecha de fin: hoy
                const endDate2025 = today;
                
                // Mismo periodo del a√±o anterior
                const startDate2024 = new Date(currentYear - 1, currentMonth, 1);
                const endDate2024 = new Date(currentYear - 1, currentMonth, currentDay);
                
                // Formatear fechas a formato ISO (YYYY-MM-DD)
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Nombres de meses en espa√±ol
                const monthNames = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                
                const label = `1-${currentDay} ${monthNames[currentMonth]} ${currentYear} vs ${currentYear - 1}`;
                
                return {
                    current: {
                        start: formatDate(startDate2025),
                        end: formatDate(endDate2025)
                    },
                    previous: {
                        start: formatDate(startDate2024),
                        end: formatDate(endDate2024)
                    },
                    label: label
                };
            };

            useEffect(() => {
                if (isLoggedIn) {
                    fetchAllData();
                }
            }, [isLoggedIn]);

            const fetchAllData = async () => {
                setLoading(true);
                setError(null);
                const results = [];
                
                // Obtener rangos de fechas din√°micos
                const dates = getDateRanges();
                setDateRange(dates);

                for (let i = 0; i < COMUNAS.length; i++) {
                    const comuna = COMUNAS[i];
                    setProgress(Math.round(((i + 1) / COMUNAS.length) * 100));
                    
                    try {
                        // Fetch data for current year
                        const urlCurrent = `https://archive-api.open-meteo.com/v1/archive?latitude=${comuna.lat}&longitude=${comuna.lon}&start_date=${dates.current.start}&end_date=${dates.current.end}&daily=temperature_2m_max,temperature_2m_min,temperature_2m_mean&timezone=auto`;
                        const resCurrent = await fetch(urlCurrent);
                        const dataCurrent = await resCurrent.json();
                        
                        // Fetch data for previous year
                        const urlPrevious = `https://archive-api.open-meteo.com/v1/archive?latitude=${comuna.lat}&longitude=${comuna.lon}&start_date=${dates.previous.start}&end_date=${dates.previous.end}&daily=temperature_2m_max,temperature_2m_min,temperature_2m_mean&timezone=auto`;
                        const resPrevious = await fetch(urlPrevious);
                        const dataPrevious = await resPrevious.json();
                        
                        // Calculate averages
                        const calculateAverage = (data) => {
                            if (!data.daily) return { max: 0, min: 0, mean: 0 };
                            
                            const max = data.daily.temperature_2m_max.reduce((a, b) => a + b, 0) / data.daily.temperature_2m_max.length;
                            const min = data.daily.temperature_2m_min.reduce((a, b) => a + b, 0) / data.daily.temperature_2m_min.length;
                            const mean = data.daily.temperature_2m_mean.reduce((a, b) => a + b, 0) / data.daily.temperature_2m_mean.length;
                            
                            return {
                                max: Math.round(max * 10) / 10,
                                min: Math.round(min * 10) / 10,
                                mean: Math.round(mean * 10) / 10
                            };
                        };
                        
                        const actualAvg = calculateAverage(dataCurrent);
                        const anteriorAvg = calculateAverage(dataPrevious);
                        
                        const calcPercentage = (val2025, val2024) => {
                            if (val2024 === 0) return 0;
                            return Math.round(((val2025 - val2024) / val2024) * 100 * 10) / 10;
                        };
                        
                        results.push({
                            comuna: comuna.nombre,
                            ventaNeta: comuna.ventaNeta,
                            actual: actualAvg,
                            anterior: anteriorAvg,
                            variacion: {
                                max: {
                                    abs: Math.round((actualAvg.max - anteriorAvg.max) * 10) / 10,
                                    pct: calcPercentage(actualAvg.max, anteriorAvg.max)
                                },
                                min: {
                                    abs: Math.round((actualAvg.min - anteriorAvg.min) * 10) / 10,
                                    pct: calcPercentage(actualAvg.min, anteriorAvg.min)
                                },
                                mean: {
                                    abs: Math.round((actualAvg.mean - anteriorAvg.mean) * 10) / 10,
                                    pct: calcPercentage(actualAvg.mean, anteriorAvg.mean)
                                }
                            }
                        });
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (err) {
                        console.error(`Error fetching data for ${comuna.nombre}:`, err);
                        setError(`Error al cargar datos de ${comuna.nombre}`);
                    }
                }
                
                setData(results);
                setLoading(false);
            };

            if (!isLoggedIn) {
                return <LoginScreen onLogin={() => setIsLoggedIn(true)} />;
            }

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Cargando Datos...</h2>
                            <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                <div className="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full transition-all duration-300"
                                     style={{width: `${progress}%`}}></div>
                            </div>
                            <p className="text-center text-gray-600">{progress}% completado</p>
                            <p className="text-center text-sm text-gray-500 mt-4">
                                Obteniendo datos de {COMUNAS.length} comunas de la V regi√≥n...
                            </p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-red-600 mb-4">Error</h2>
                            <p className="text-gray-700 mb-6">{error}</p>
                            <button
                                onClick={fetchAllData}
                                className="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition"
                            >
                                Reintentar
                            </button>
                        </div>
                    </div>
                );
            }

            // Calculate subtotals
            const comunasDIMER = organizedData.filter(row => COMUNAS_DIMER.includes(row.comuna));
            const comunasOTRAS = organizedData.filter(row => !COMUNAS_DIMER.includes(row.comuna));
            
            const avgDIMER = calculateGroupAverage(comunasDIMER, usePonderado);
            const avgOTRAS = calculateGroupAverage(comunasOTRAS, usePonderado);

            const getVariationColor = (value) => {
                if (value > 1) return 'text-red-600 bg-red-50';
                if (value < -1) return 'text-blue-600 bg-blue-50';
                return 'text-gray-600 bg-white';
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                        üå°Ô∏è An√°lisis de Temperaturas - V Regi√≥n
                                    </h1>
                                    <p className="text-gray-600">
                                        Comparaci√≥n {dateRange.label}
                                    </p>
                                </div>
                                <button
                                    onClick={() => setIsLoggedIn(false)}
                                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition"
                                >
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>

                        {/* Toggle and Filters */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            {/* Ponderado Toggle */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">‚öñÔ∏è M√©todo de C√°lculo</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    {usePonderado 
                                        ? 'Promedios ponderados por venta neta mensual (comunas con m√°s ventas pesan m√°s)'
                                        : 'Promedios simples (todas las comunas pesan igual)'
                                    }
                                </p>
                                <div className="flex items-center space-x-4">
                                    <span className={`text-sm font-medium ${!usePonderado ? 'text-gray-800' : 'text-gray-400'}`}>
                                        Simple
                                    </span>
                                    <button
                                        onClick={() => setUsePonderado(!usePonderado)}
                                        className={`relative inline-flex h-8 w-16 items-center rounded-full transition-colors ${
                                            usePonderado ? 'bg-purple-600' : 'bg-gray-300'
                                        }`}
                                    >
                                        <span className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${
                                            usePonderado ? 'translate-x-9' : 'translate-x-1'
                                        }`} />
                                    </button>
                                    <span className={`text-sm font-medium ${usePonderado ? 'text-gray-800' : 'text-gray-400'}`}>
                                        Ponderado
                                    </span>
                                </div>
                            </div>

                            {/* Province Filter */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">üìç Filtrar por Provincia</h3>
                                <select
                                    value={selectedProvince}
                                    onChange={(e) => setSelectedProvince(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                >
                                    {provincias.map(provincia => (
                                        <option key={provincia} value={provincia}>
                                            {provincia === 'Todas' ? 'üåç Todas las Comunas' : 
                                             provincia === 'DIMER' ? 'üéØ Solo DIMER' :
                                             provincia === 'Otras' ? 'üèòÔ∏è Solo Otras' :
                                             `üìç ${provincia}`}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        {selectedProvince === 'Todas' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                {/* DIMER Card */}
                                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
                                    <h3 className="text-xl font-bold mb-4">üéØ Comunas DIMER</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <p className="text-blue-100 text-sm">Temperatura Promedio</p>
                                            <p className="text-3xl font-bold">{avgDIMER?.actual.mean}¬∞C</p>
                                            <p className="text-sm">
                                                vs {avgDIMER?.anterior.mean}¬∞C el a√±o anterior
                                                <span className="ml-2">
                                                    ({avgDIMER?.variacion.mean.abs > 0 ? '+' : ''}
                                                    {avgDIMER?.variacion.mean.abs}¬∞C)
                                                </span>
                                            </p>
                                        </div>
                                        <div className="pt-3 border-t border-blue-400">
                                            <p className="text-blue-100 text-sm">Venta Neta Total</p>
                                            <p className="text-xl font-bold">{formatVentaNeta(avgDIMER?.ventaNeta || 0)}</p>
                                            <p className="text-sm text-blue-100">{usePonderado ? 'Promedio ponderado por ventas' : 'Promedio simple'}</p>
                                        </div>
                                    </div>
                                </div>

                                {/* OTRAS Card */}
                                <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-xl p-6 text-white">
                                    <h3 className="text-xl font-bold mb-4">üèòÔ∏è Otras Comunas</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <p className="text-purple-100 text-sm">Temperatura Promedio</p>
                                            <p className="text-3xl font-bold">{avgOTRAS?.actual.mean}¬∞C</p>
                                            <p className="text-sm">
                                                vs {avgOTRAS?.anterior.mean}¬∞C el a√±o anterior
                                                <span className="ml-2">
                                                    ({avgOTRAS?.variacion.mean.abs > 0 ? '+' : ''}
                                                    {avgOTRAS?.variacion.mean.abs}¬∞C)
                                                </span>
                                            </p>
                                        </div>
                                        <div className="pt-3 border-t border-purple-400">
                                            <p className="text-purple-100 text-sm">Venta Neta Total</p>
                                            <p className="text-xl font-bold">{formatVentaNeta(avgOTRAS?.ventaNeta || 0)}</p>
                                            <p className="text-sm text-purple-100">{usePonderado ? 'Promedio ponderado por ventas' : 'Promedio simple'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Data Table */}
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                                        <tr>
                                            <th className="px-4 py-4 text-left font-semibold">Comuna</th>
                                            <th className="px-4 py-4 text-right font-semibold">Venta Neta Nov 2024</th>
                                            <th className="px-4 py-4 text-center font-semibold">
                                                M√°xima<br/>
                                                <span className="text-xs font-normal">
                                                    {dateRange.current?.end.split('-')[0]}/{dateRange.previous?.end.split('-')[0]}
                                                </span>
                                            </th>
                                            <th className="px-4 py-4 text-center font-semibold">Variaci√≥n</th>
                                            <th className="px-4 py-4 text-center font-semibold">
                                                M√≠nima<br/>
                                                <span className="text-xs font-normal">
                                                    {dateRange.current?.end.split('-')[0]}/{dateRange.previous?.end.split('-')[0]}
                                                </span>
                                            </th>
                                            <th className="px-4 py-4 text-center font-semibold">Variaci√≥n</th>
                                            <th className="px-4 py-4 text-center font-semibold">
                                                Promedio<br/>
                                                <span className="text-xs font-normal">
                                                    {dateRange.current?.end.split('-')[0]}/{dateRange.previous?.end.split('-')[0]}
                                                </span>
                                            </th>
                                            <th className="px-4 py-4 text-center font-semibold">Variaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {/* Subtotal DIMER */}
                                        {selectedProvince === 'Todas' && avgDIMER && (
                                            <tr className="bg-blue-50 font-bold">
                                                <td className="px-4 py-4">
                                                    <div className="flex items-center">
                                                        <span className="text-blue-600">üéØ SUBTOTAL DIMER</span>
                                                        <span className="ml-2 text-xs text-gray-500">
                                                            ({usePonderado ? 'Ponderado' : 'Simple'})
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-4 text-right text-blue-600">
                                                    {formatVentaNeta(avgDIMER.ventaNeta)}
                                                </td>
                                                <td className="px-4 py-4 text-center">
                                                    <div className="font-semibold text-red-600">{avgDIMER.actual.max}¬∞</div>
                                                    <div className="text-xs text-gray-500">{avgDIMER.anterior.max}¬∞</div>
                                                </td>
                                                <td className={`px-4 py-4 text-center ${getVariationColor(avgDIMER.variacion.max.abs)}`}>
                                                    <div className="font-bold">
                                                        {avgDIMER.variacion.max.abs > 0 ? '+' : ''}{avgDIMER.variacion.max.abs}¬∞
                                                    </div>
                                                    <div className="text-xs">
                                                        ({avgDIMER.variacion.max.pct > 0 ? '+' : ''}{avgDIMER.variacion.max.pct}%)
                                                    </div>
                                                </td>
                                                <td className="px-4 py-4 text-center">
                                                    <div className="font-semibold text-blue-600">{avgDIMER.actual.min}¬∞</div>
                                                    <div className="text-xs text-gray-500">{avgDIMER.anterior.min}¬∞</div>
                                                </td>
                                                <td className={`px-4 py-4 text-center ${getVariationColor(avgDIMER.variacion.min.abs)}`}>
                                                    <div className="font-bold">
                                                        {avgDIMER.variacion.min.abs > 0 ? '+' : ''}{avgDIMER.variacion.min.abs}¬∞
                                                    </div>
                                                    <div className="text-xs">
                                                        ({avgDIMER.variacion.min.pct > 0 ? '+' : ''}{avgDIMER.variacion.min.pct}%)
                                                    </div>
                                                </td>
                                                <td className="px-4 py-4 text-center">
                                                    <div className="font-semibold text-gray-800">{avgDIMER.actual.mean}¬∞</div>
                                                    <div className="text-xs text-gray-500">{avgDIMER.anterior.mean}¬∞</div>
                                                </td>
                                                <td className={`px-4 py-4 text-center ${getVariationColor(avgDIMER.variacion.mean.abs)}`}>
                                                    <div className="font-bold">
                                                        {avgDIMER.variacion.mean.abs > 0 ? '+' : ''}{avgDIMER.variacion.mean.abs}¬∞
                                                    </div>
                                                    <div className="text-xs">
                                                        ({avgDIMER.variacion.mean.pct > 0 ? '+' : ''}{avgDIMER.variacion.mean.pct}%)
                                                    </div>
                                                </td>
                                            </tr>
                                        )}

                                        {/* Individual Rows */}
                                        {filteredData.map((row, index) => {
                                            const isDimer = COMUNAS_DIMER.includes(row.comuna);
                                            
                                            // Show OTRAS subtotal before first non-DIMER comuna
                                            const showOtrasSubtotal = selectedProvince === 'Todas' && 
                                                index > 0 && 
                                                COMUNAS_DIMER.includes(filteredData[index - 1].comuna) && 
                                                !isDimer && 
                                                avgOTRAS;
                                            
                                            return (
                                                <React.Fragment key={row.comuna}>
                                                    {showOtrasSubtotal && (
                                                        <tr className="bg-purple-50 font-bold">
                                                            <td className="px-4 py-4">
                                                                <div className="flex items-center">
                                                                    <span className="text-purple-600">üèòÔ∏è SUBTOTAL OTRAS</span>
                                                                    <span className="ml-2 text-xs text-gray-500">
                                                                        ({usePonderado ? 'Ponderado' : 'Simple'})
                                                                    </span>
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-4 text-right text-purple-600">
                                                                {formatVentaNeta(avgOTRAS.ventaNeta)}
                                                            </td>
                                                            <td className="px-4 py-4 text-center">
                                                                <div className="font-semibold text-red-600">{avgOTRAS.actual.max}¬∞</div>
                                                                <div className="text-xs text-gray-500">{avgOTRAS.anterior.max}¬∞</div>
                                                            </td>
                                                            <td className={`px-4 py-4 text-center ${getVariationColor(avgOTRAS.variacion.max.abs)}`}>
                                                                <div className="font-bold">
                                                                    {avgOTRAS.variacion.max.abs > 0 ? '+' : ''}{avgOTRAS.variacion.max.abs}¬∞
                                                                </div>
                                                                <div className="text-xs">
                                                                    ({avgOTRAS.variacion.max.pct > 0 ? '+' : ''}{avgOTRAS.variacion.max.pct}%)
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-4 text-center">
                                                                <div className="font-semibold text-blue-600">{avgOTRAS.actual.min}¬∞</div>
                                                                <div className="text-xs text-gray-500">{avgOTRAS.anterior.min}¬∞</div>
                                                            </td>
                                                            <td className={`px-4 py-4 text-center ${getVariationColor(avgOTRAS.variacion.min.abs)}`}>
                                                                <div className="font-bold">
                                                                    {avgOTRAS.variacion.min.abs > 0 ? '+' : ''}{avgOTRAS.variacion.min.abs}¬∞
                                                                </div>
                                                                <div className="text-xs">
                                                                    ({avgOTRAS.variacion.min.pct > 0 ? '+' : ''}{avgOTRAS.variacion.min.pct}%)
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-4 text-center">
                                                                <div className="font-semibold text-gray-800">{avgOTRAS.actual.mean}¬∞</div>
                                                                <div className="text-xs text-gray-500">{avgOTRAS.anterior.mean}¬∞</div>
                                                            </td>
                                                            <td className={`px-4 py-4 text-center ${getVariationColor(avgOTRAS.variacion.mean.abs)}`}>
                                                                <div className="font-bold">
                                                                    {avgOTRAS.variacion.mean.abs > 0 ? '+' : ''}{avgOTRAS.variacion.mean.abs}¬∞
                                                                </div>
                                                                <div className="text-xs">
                                                                    ({avgOTRAS.variacion.mean.pct > 0 ? '+' : ''}{avgOTRAS.variacion.mean.pct}%)
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                    
                                                    <tr className={isDimer ? 'bg-blue-50/30' : 'hover:bg-gray-50'}>
                                                        <td className="px-4 py-4">
                                                            <div className="font-semibold text-gray-800">
                                                                {isDimer && 'üéØ '}{row.comuna}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-4 text-right text-sm text-gray-600">
                                                            {formatVentaNeta(row.ventaNeta)}
                                                        </td>
                                                        <td className="px-4 py-4 text-center">
                                                            <div className="font-semibold text-red-600">{row.actual.max}¬∞</div>
                                                            <div className="text-xs text-gray-500">{row.anterior.max}¬∞</div>
                                                        </td>
                                                        <td className={`px-4 py-4 text-center ${getVariationColor(row.variacion.max.abs)}`}>
                                                            <div className="font-bold">
                                                                {row.variacion.max.abs > 0 ? '+' : ''}{row.variacion.max.abs}¬∞
                                                            </div>
                                                            <div className="text-xs">
                                                                ({row.variacion.max.pct > 0 ? '+' : ''}{row.variacion.max.pct}%)
                                                            </div>
                                                        </td>
                                                        
                                                        <td className="px-4 py-4 text-center">
                                                            <div className="font-semibold text-blue-600">{row.actual.min}¬∞</div>
                                                            <div className="text-xs text-gray-500">{row.anterior.min}¬∞</div>
                                                        </td>
                                                        <td className={`px-4 py-4 text-center ${getVariationColor(row.variacion.min.abs)}`}>
                                                            <div className="font-bold">
                                                                {row.variacion.min.abs > 0 ? '+' : ''}{row.variacion.min.abs}¬∞
                                                            </div>
                                                            <div className="text-xs">
                                                                ({row.variacion.min.pct > 0 ? '+' : ''}{row.variacion.min.pct}%)
                                                            </div>
                                                        </td>
                                                        
                                                        <td className="px-4 py-4 text-center">
                                                            <div className="font-semibold text-gray-800">{row.actual.mean}¬∞</div>
                                                            <div className="text-xs text-gray-500">{row.anterior.mean}¬∞</div>
                                                        </td>
                                                        <td className={`px-4 py-4 text-center ${getVariationColor(row.variacion.mean.abs)}`}>
                                                            <div className="font-bold">
                                                                {row.variacion.mean.abs > 0 ? '+' : ''}{row.variacion.mean.abs}¬∞
                                                                {row.variacion.mean.abs > 0 ? ' üî•' : row.variacion.mean.abs < 0 ? ' ‚ùÑÔ∏è' : ' ‚û°Ô∏è'}
                                                            </div>
                                                            <div className="text-xs">
                                                                ({row.variacion.mean.pct > 0 ? '+' : ''}{row.variacion.mean.pct}%)
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </React.Fragment>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Legend */}
                        <div className="mt-6 bg-white rounded-lg shadow-lg p-6">
                            <h3 className="font-semibold text-gray-800 mb-3">üìä Informaci√≥n</h3>
                            
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                                <h4 className="font-bold text-blue-900 mb-2">üè¢ Comunas DIMER</h4>
                                <p className="text-sm text-blue-800">
                                    Vi√±a del Mar ‚Ä¢ Valpara√≠so ‚Ä¢ Quilpu√© ‚Ä¢ Villa Alemana ‚Ä¢ Olmu√© ‚Ä¢ Limache
                                </p>
                            </div>
                            
                            {usePonderado ? (
                                <div className="bg-purple-50 border-l-4 border-purple-500 p-4 mb-4">
                                    <h4 className="font-bold text-purple-900 mb-2">‚öñÔ∏è Promedios Ponderados por Venta Neta (ACTIVO)</h4>
                                    <p className="text-sm text-purple-800 mb-2">
                                        Los subtotales DIMER y OTRAS utilizan promedios ponderados por venta neta mensual. Esto significa que comunas con mayores ventas tienen mayor peso en el c√°lculo, reflejando mejor el impacto real del mercado.
                                    </p>
                                    <div className="bg-white rounded p-3 mt-2">
                                        <p className="text-xs text-purple-900 font-mono">
                                            Promedio = Œ£(Temperatura √ó Venta Neta) / Œ£(Venta Neta)
                                        </p>
                                    </div>
                                    <p className="text-xs text-purple-700 mt-2">
                                        <strong>Ejemplo:</strong> Vi√±a del Mar ($325M) tiene ~12x m√°s peso que Limache ($53M) en el c√°lculo.
                                    </p>
                                </div>
                            ) : (
                                <div className="bg-gray-100 border-l-4 border-gray-500 p-4 mb-4">
                                    <h4 className="font-bold text-gray-900 mb-2">üìä Promedios Simples (ACTIVO)</h4>
                                    <p className="text-sm text-gray-800 mb-2">
                                        Los subtotales DIMER y OTRAS utilizan promedios simples. Todas las comunas tienen el mismo peso, independientemente de su venta neta.
                                    </p>
                                    <div className="bg-white rounded p-3 mt-2">
                                        <p className="text-xs text-gray-900 font-mono">
                                            Promedio = Œ£(Temperatura) / Cantidad de Comunas
                                        </p>
                                    </div>
                                    <p className="text-xs text-gray-700 mt-2">
                                        <strong>Ejemplo:</strong> Vi√±a del Mar y Olmu√© tienen exactamente el mismo peso (1/6) en el c√°lculo del promedio DIMER.
                                    </p>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                                <div>
                                    <span className="font-semibold">Promedio M√°ximas:</span> Promedio de las temperaturas m√°ximas diarias del periodo
                                </div>
                                <div>
                                    <span className="font-semibold">Promedio M√≠nimas:</span> Promedio de las temperaturas m√≠nimas diarias del periodo
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-red-50 border border-red-200 rounded"></div>
                                    <span>M√°s c√°lido que 2024 (m√°s de +1¬∞C)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-blue-50 border border-blue-200 rounded"></div>
                                    <span>M√°s fr√≠o que 2024 (menos de -1¬∞C)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-white border border-gray-200 rounded"></div>
                                    <span>Similar a 2024 (-1¬∞C a +1¬∞C)</span>
                                </div>
                            </div>
                            <p className="text-xs text-gray-500 mt-4">
                                Datos obtenidos de Open-Meteo API ‚Ä¢ {COMUNAS.length} comunas de la V regi√≥n (6 DIMER + {COMUNAS.length - 6} otras) ‚Ä¢ Periodo: {dateRange.label || 'Cargando...'} ‚Ä¢ Venta Neta: Noviembre 2024 ‚Ä¢ Actualizado: {new Date().toLocaleDateString('es-CL', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TemperatureComparison />, document.getElementById('root'));
    </script>
</body>
</html>
